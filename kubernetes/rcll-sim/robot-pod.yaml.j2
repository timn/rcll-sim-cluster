# Headless service for robot Pod
apiVersion: v1
kind: Service
metadata:
  name: {{ robot.service_name }}
  namespace: {{ namespace }}
spec:
  selector:
    app: fawkes
    robot: {{ robot.name }}
  clusterIP: None
  ports:
  - port: 1
---
# Service for Fawkes on that robot
apiVersion: v1
kind: Service
metadata:
  name: {{ fawkes.service_name }}
  namespace: {{ namespace }}
spec:
  selector:
    app: fawkes
    robot: {{ robot.name }}
  ports:
  - port: {{ fawkes.port }}
---
apiVersion: v1
kind: Pod
metadata:
  name: {{ robot.pod_name }}
  namespace: {{ namespace }}
  labels:
    robot: {{ robot.name }}
    app: fawkes
  annotations:
    pod.beta.kubernetes.io/init-containers: '[
        {
          "name": "wait-for-rcll-sim",
          "image": "{{ rcll_sim_image }}",
    			"imagePullPolicy": "Always",
          "command": ["/opt/rcll-sim/wait-services"],
          "args": ["gazebo", "refbox"],
          "env": [
            {
              "name": "MAX_TRIES",
              "value": "30"
            }
          ]
        }
      ]'
spec:
  containers:
  - name: roscore
    image: {{ rcll_sim_image }}
    command: ["/opt/rcll-sim/run-component"]
    args: ["roscore"]
  - name: fawkes
    image: {{ rcll_sim_image }}
    imagePullPolicy: Always
    command: ["/opt/rcll-sim/run-component"]
    args: ["fawkes"]
    env:
    - name: CONFIG
      value: gazsim-configurations/default/robotino{{ robot.num }}.yaml
    - name: META_PLUGIN
      value: {{ robot.plugins|default("gazsim-meta-robotino-ros,gazsim-meta-robotino-vision-high-level,gazsim-meta-agent,gazsim-navgraph-generator") }}
    - name: LOG_LEVEL
      value: debug
    - name: GAZEBO_MASTER_URI
      value: http://gazebo:11345

  - name: localize-robot
    image: {{ rcll_sim_image }}
    command: ["/opt/rcll-sim/localize-robot"]
    args: ["C-R1"]
    env:
    - name: REMOTE
      value: localhost:{{ fawkes.port }}

  imagePullSecrets:
    - name: regsecret
  restartPolicy: Never
